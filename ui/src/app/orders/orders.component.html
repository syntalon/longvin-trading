<div class="orders-container">
  <h1>Order Search</h1>
  
  <div class="search-filters">
    <h2>Search Filters</h2>
    <div class="filter-row">
      <div class="filter-group">
        <label for="accountNumber">Account Number:</label>
        <input type="text" id="accountNumber" [(ngModel)]="accountNumber" placeholder="e.g., TROS107">
      </div>
      
      <div class="filter-group">
        <label for="symbol">Symbol:</label>
        <input type="text" id="symbol" [(ngModel)]="symbol" placeholder="e.g., DRMA">
      </div>
      
      <div class="filter-group">
        <label for="fixClOrdId">ClOrdID:</label>
        <input type="text" id="fixClOrdId" [(ngModel)]="fixClOrdId" placeholder="e.g., 12345 or COPY-...">
      </div>
      
      <div class="filter-group">
        <label for="fixOrderId">OrderID:</label>
        <input type="text" id="fixOrderId" [(ngModel)]="fixOrderId" placeholder="e.g., 12345">
      </div>
    </div>
    
    <div class="filter-row">
      <div class="filter-group">
        <label for="ordStatus">Order Status:</label>
        <select id="ordStatus" [(ngModel)]="ordStatus">
          <option *ngFor="let opt of ordStatusOptions" [value]="opt.value">{{ opt.label }}</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="execType">Execution Type:</label>
        <select id="execType" [(ngModel)]="execType">
          <option *ngFor="let opt of execTypeOptions" [value]="opt.value">{{ opt.label }}</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="isCopyOrder">Copy Order:</label>
        <select id="isCopyOrder" [(ngModel)]="isCopyOrder">
          <option [value]="null">All</option>
          <option [value]="true">Copy Orders Only</option>
          <option [value]="false">Primary Orders Only</option>
        </select>
      </div>
    </div>
    
    <div class="filter-row">
      <div class="filter-group">
        <label for="startDate">Start Date/Time:</label>
        <input type="datetime-local" id="startDate" [(ngModel)]="startDate">
      </div>
      
      <div class="filter-group">
        <label for="endDate">End Date/Time:</label>
        <input type="datetime-local" id="endDate" [(ngModel)]="endDate">
      </div>
    </div>
    
    <div class="filter-actions">
      <button (click)="searchOrders()" [disabled]="loading">Search</button>
      <button (click)="clearFilters()" [disabled]="loading">Clear</button>
    </div>
  </div>
  
  <div class="error-message" *ngIf="error">
    {{ error }}
  </div>
  
  <div class="loading" *ngIf="loading">
    Loading orders...
  </div>
  
  <div class="orders-table" *ngIf="!loading && orders.length > 0">
    <table>
      <thead>
        <tr>
          <th>ClOrdID</th>
          <th>OrderID</th>
          <th>Account</th>
          <th>Type</th>
          <th>Symbol</th>
          <th>Side</th>
          <th>Order Type</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Status</th>
          <th>Cum Qty</th>
          <th>Avg Px</th>
          <th>Created</th>
          <th>Group</th>
          <th>Events</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let order of getDisplayOrders()">
          <tr 
            [class.copy-order]="order.isCopyOrder" 
            [class.group-member]="order.isGroupMember"
            [class.primary-order]="!order.isCopyOrder && !order.isGroupMember"
            [style.padding-left.px]="order.indentLevel ? order.indentLevel * 20 : 0">
            <td>
              <span *ngIf="order.indentLevel && order.indentLevel > 0" class="indent-indicator">└─</span>
              <span [title]="order.fixClOrdId || 'N/A'">
                {{ order.fixClOrdId || 'N/A' }}
              </span>
              <span class="copy-badge" *ngIf="order.isCopyOrder">COPY</span>
            </td>
            <td>{{ order.fixOrderId || 'N/A' }}</td>
            <td>
              <span [title]="order.accountNumber || 'N/A'">
                {{ order.accountNumber || 'N/A' }}
              </span>
              <span class="account-type" *ngIf="order.accountType">
                ({{ order.accountType }})
              </span>
            </td>
            <td>
              <span class="order-type-badge" [class.primary]="!order.isCopyOrder" [class.shadow]="order.isCopyOrder">
                {{ order.isCopyOrder ? 'Shadow' : 'Primary' }}
              </span>
            </td>
            <td>{{ order.symbol || 'N/A' }}</td>
            <td>{{ getSideLabel(order.side, order) }}</td>
            <td>{{ getOrdTypeLabel(order.ordType) }}</td>
            <td>{{ order.orderQty || 'N/A' }}</td>
            <td>{{ order.price || 'N/A' }}</td>
            <td>
              <span class="status-badge" [class.filled]="order.ordStatus === '2'" [class.partial]="order.ordStatus === '1'">
                {{ getOrdStatusLabel(order.ordStatus) }}
              </span>
            </td>
            <td>{{ order.cumQty || 'N/A' }}</td>
            <td>{{ order.avgPx || 'N/A' }}</td>
            <td>{{ formatDateTime(order.createdAt) }}</td>
            <td>
              <button 
                *ngIf="(order.primaryOrderClOrdId || order.fixClOrdId) && !order.isGroupMember" 
                (click)="toggleOrderGroup(order)" 
                class="btn-link"
                [disabled]="isLoadingGroup(order)">
                <span *ngIf="isLoadingGroup(order)">Loading...</span>
                <span *ngIf="!isLoadingGroup(order)">
                  {{ isGroupExpanded(order) ? 'Hide Group' : 'View Group' }}
                </span>
              </button>
              <span *ngIf="!order.primaryOrderClOrdId && !order.fixClOrdId && !order.isGroupMember">-</span>
              <span *ngIf="order.isGroupMember" class="group-indicator">Group Member</span>
            </td>
            <td>
              <span class="event-count" [title]="'Total events: ' + (order.eventCount || 0)">
                {{ order.eventCount || 0 }} event(s)
              </span>
            </td>
            <td>
              <button 
                (click)="viewOrderEvents(order)" 
                class="btn-link"
                [disabled]="isLoadingEvents(order)">
                <span *ngIf="isLoadingEvents(order)">Loading...</span>
                <span *ngIf="!isLoadingEvents(order)">View Events</span>
              </button>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
    
    <div class="results-info">
      Found {{ orders.length }} order(s)
    </div>
  </div>
  
  <div class="no-results" *ngIf="!loading && orders.length === 0 && !error">
    No orders found. Try adjusting your search filters.
  </div>
</div>

<!-- Order Events Modal -->
<div class="modal-overlay" *ngIf="showEventsModal" (click)="closeEventsModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Order Events</h2>
      <button class="close-btn" (click)="closeEventsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div *ngIf="loadingEvents" class="loading">Loading events...</div>
      <div *ngIf="!loadingEvents && selectedOrderEvents.length === 0" class="no-results">
        No events found for this order.
      </div>
      <div *ngIf="!loadingEvents && selectedOrderEvents.length > 0" class="events-table">
        <table>
          <thead>
            <tr>
              <th>Event Time</th>
              <th>Exec Type</th>
              <th>Ord Status</th>
              <th>Exec ID</th>
              <th>OrderID</th>
              <th>ClOrdID</th>
              <th>Symbol</th>
              <th>Side</th>
              <th>Qty</th>
              <th>Price</th>
              <th>Cum Qty</th>
              <th>Avg Px</th>
              <th>Text</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let event of selectedOrderEvents">
              <td>{{ formatDateTime(event.eventTime) }}</td>
              <td>{{ getExecTypeLabel(event.execType) }}</td>
              <td>{{ getOrdStatusLabel(event.ordStatus) }}</td>
              <td>{{ event.fixExecId || 'N/A' }}</td>
              <td>{{ event.fixOrderId || 'N/A' }}</td>
              <td>{{ event.fixClOrdId || 'N/A' }}</td>
              <td>{{ event.symbol || 'N/A' }}</td>
              <td>{{ getSideLabel(event.side) }}</td>
              <td>{{ event.orderQty || 'N/A' }}</td>
              <td>{{ event.price || 'N/A' }}</td>
              <td>{{ event.cumQty || 'N/A' }}</td>
              <td>{{ event.avgPx || 'N/A' }}</td>
              <td>{{ event.text || '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

