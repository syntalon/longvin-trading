# Default configuration (used when no profile is specified)
# This acts as the production configuration
# Environment variables can override these values using ${VARIABLE:default} syntax
spring:
  application:
    name: LongvinTradingBackend
  datasource:
    url: jdbc:postgresql://${DB_HOST:dev-chia.postgres.database.azure.com}:${DB_PORT:5432}/${DB_NAME:dev_svc_longvin}?sslmode=${DB_SSLMODE:require}&sslfactory=org.postgresql.ssl.DefaultJavaSSLFactory&connectTimeout=60&socketTimeout=60&loginTimeout=30&currentSchema=${DB_SCHEMA:svc_longvin}
    driver-class-name: org.postgresql.Driver
    # For Azure PostgreSQL:
    # - Single Server: username@servername (e.g., svc_longvin_user@dev-chia)
    # - Flexible Server: username (e.g., svc_longvin_user)
    # Default is without @servername for Flexible Server compatibility
    username: ${DB_USERNAME:svc_longvin_user}
    password: ${DB_PASSWORD:syntalon@123}
    hikari:
      connection-timeout: ${DB_CONNECTION_TIMEOUT:60000}
      maximum-pool-size: ${DB_MAX_POOL_SIZE:5}
      minimum-idle: ${DB_MIN_IDLE:1}
      idle-timeout: ${DB_IDLE_TIMEOUT:300000}
      max-lifetime: ${DB_MAX_LIFETIME:1200000}
      leak-detection-threshold: ${DB_LEAK_DETECTION_THRESHOLD:60000}
      schema: ${DB_SCHEMA:svc_longvin}
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: validate  # Use Flyway for migrations, validate schema matches entities
    show-sql: ${JPA_SHOW_SQL:false}
    properties:
      hibernate:
        format_sql: true
        default_schema: ${DB_SCHEMA:svc_longvin}
  flyway:
    enabled: ${FLYWAY_ENABLED:true}
    locations: classpath:db/migration
    baseline-on-migrate: ${FLYWAY_BASELINE_ON_MIGRATE:true}
    baseline-version: ${FLYWAY_BASELINE_VERSION:0}
    schemas: ${DB_SCHEMA:svc_longvin}
    default-schema: ${DB_SCHEMA:svc_longvin}
    # PostgreSQL 17 support
    database-type: postgresql

server:
  port: ${SERVER_PORT:8081}

logging:
  file:
    name: ${LOGGING_FILE_NAME:logs/application.log}
    max-size: ${LOGGING_FILE_MAX_SIZE:10MB}
    max-history: ${LOGGING_FILE_MAX_HISTORY:30}
  level:
    quickfix: ${LOG_LEVEL_QUICKFIX:DEBUG}
    quickfix.mina: ${LOG_LEVEL_QUICKFIX_MINA:DEBUG}
    com.longvin.trading.fix: ${LOG_LEVEL_FIX:DEBUG}

trading:
  initiator:
    non-trading-resume-hour: ${TRADING_NON_TRADING_RESUME_HOUR:6}
  fix:
    enabled: ${FIX_ENABLED:true}
    config-path: ${FIX_CONFIG_PATH:classpath:fix/das-mirror-trading.cfg}
    primary-session: ${FIX_PRIMARY_SESSION:OS111}
    drop-copy-session-sender-comp-id: ${FIX_DROP_COPY_SENDER_COMP_ID:OS111}
    drop-copy-session-target-comp-id: ${FIX_DROP_COPY_TARGET_COMP_ID:DAST}
    primary-account: ${FIX_PRIMARY_ACCOUNT:PRIMARY_ACCOUNT}
    shadow-sessions: ${FIX_SHADOW_SESSIONS:SHADOW1,SHADOW2}
    shadow-accounts:
      SHADOW1: ${FIX_SHADOW_ACCOUNT_1:SHADOW_ACCOUNT_1}
      SHADOW2: ${FIX_SHADOW_ACCOUNT_2:SHADOW_ACCOUNT_2}
    shadow-account-policies:
      SHADOW1:
        ratio: ${FIX_SHADOW1_RATIO:5.0}
        replenish-window: ${FIX_SHADOW1_REPLENISH_WINDOW:PT2M}
        holding-window: ${FIX_SHADOW1_HOLDING_WINDOW:PT3M}
        partial-cancel-window: ${FIX_SHADOW1_PARTIAL_CANCEL_WINDOW:PT30S}
      SHADOW2:
        ratio: ${FIX_SHADOW2_RATIO:1.0}
        replenish-window: ${FIX_SHADOW2_REPLENISH_WINDOW:PT2M}
        holding-window: ${FIX_SHADOW2_HOLDING_WINDOW:PT2M}
        partial-cancel-window: ${FIX_SHADOW2_PARTIAL_CANCEL_WINDOW:PT20S}
    cl-ord-id-prefix: ${FIX_CL_ORD_ID_PREFIX:MIRROR-}
---
# Production profile configuration
# This is the default profile for production use
# Environment variables can override these values
spring:
  config:
    activate:
      on-profile: prod
  datasource:
    url: jdbc:postgresql://${DB_HOST:dev-chia.postgres.database.azure.com}:${DB_PORT:5432}/${DB_NAME:dev_svc_longvin}?sslmode=${DB_SSLMODE:require}&sslfactory=org.postgresql.ssl.DefaultJavaSSLFactory&connectTimeout=60&socketTimeout=60&loginTimeout=30&currentSchema=${DB_SCHEMA:svc_longvin}
    driver-class-name: org.postgresql.Driver
    # For Azure PostgreSQL:
    # - Single Server: username@servername (e.g., svc_longvin_user@dev-chia)
    # - Flexible Server: username (e.g., svc_longvin_user)
    # Default is without @servername for Flexible Server compatibility
    username: ${DB_USERNAME:svc_longvin_user}
    password: ${DB_PASSWORD:syntalon@123}
    hikari:
      connection-timeout: ${DB_CONNECTION_TIMEOUT:60000}
      maximum-pool-size: ${DB_MAX_POOL_SIZE:5}
      minimum-idle: ${DB_MIN_IDLE:1}
      idle-timeout: ${DB_IDLE_TIMEOUT:300000}
      max-lifetime: ${DB_MAX_LIFETIME:1200000}
      leak-detection-threshold: ${DB_LEAK_DETECTION_THRESHOLD:60000}
      schema: ${DB_SCHEMA:svc_longvin}
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: validate  # Use Flyway for migrations
    show-sql: ${JPA_SHOW_SQL:false}
    properties:
      hibernate:
        format_sql: true
        default_schema: ${DB_SCHEMA:svc_longvin}
  flyway:
    enabled: ${FLYWAY_ENABLED:true}
    locations: classpath:db/migration
    baseline-on-migrate: ${FLYWAY_BASELINE_ON_MIGRATE:true}
    schemas: ${DB_SCHEMA:svc_longvin}
    default-schema: ${DB_SCHEMA:svc_longvin}
    database-type: postgresql
    # Note: Schema must be created manually by admin using SETUP_SCHEMA.sql
    # The migration user (svc_longvin_user) doesn't have permission to create schemas
    create-schemas: ${FLYWAY_CREATE_SCHEMAS:false}

trading:
  fix:
    # Production FIX config (explicit, though already default)
    config-path: ${FIX_CONFIG_PATH:classpath:fix/das-mirror-trading.cfg}

logging:
  level:
    com.longvin.trading: ${LOG_LEVEL_APP:INFO}
    quickfix: ${LOG_LEVEL_QUICKFIX:INFO}
    quickfix.mina: ${LOG_LEVEL_QUICKFIX_MINA:WARN}

---
# Test profile configuration
# Use this profile for testing with the simulator
# Run with: --spring.profiles.active=test
spring:
  config:
    activate:
      on-profile: simulator
  datasource:
    url: jdbc:h2:mem:tradingdb-test
    driver-class-name: org.h2.Driver
    username: sa
    password:
  h2:
    console:
      enabled: true
      path: /h2-console
  jpa:
    database-platform: org.hibernate.dialect.H2Dialect
    hibernate:
      ddl-auto: validate  # Use Flyway for migrations
    show-sql: false
    properties:
      hibernate:
        format_sql: true
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true

trading:
  initiator:
    non-trading-resume-hour: 6
  fix:
    enabled: true
    # Override config to use test configuration pointing to simulator
    config-path: classpath:fix/das-mirror-trading-simulator.cfg
    primary-session: OPAL
    drop-copy-session-sender-comp-id: OS111
    drop-copy-session-target-comp-id: DAST
    primary-account: PRIMARY_ACCOUNT
    shadow-sessions: SHADOW1,SHADOW2
    shadow-accounts:
      SHADOW1: SHADOW_ACCOUNT_1
      SHADOW2: SHADOW_ACCOUNT_2
    shadow-account-policies:
      SHADOW1:
        ratio: 5.0
        replenish-window: PT2M
        holding-window: PT3M
        partial-cancel-window: PT30S
      SHADOW2:
        ratio: 1.0
        replenish-window: PT2M
        holding-window: PT2M
        partial-cancel-window: PT20S
    cl-ord-id-prefix: MIRROR-
---
# Dev profile configuration
spring:
  config:
    activate:
      on-profile: dev
  datasource:
    url: jdbc:h2:mem:tradingdb-dev
    driver-class-name: org.h2.Driver
    username: sa
    password:
  h2:
    console:
      enabled: true
      path: /h2-console
  jpa:
    database-platform: org.hibernate.dialect.H2Dialect
    hibernate:
      ddl-auto: validate  # Use Flyway for migrations
    show-sql: false
    properties:
      hibernate:
        format_sql: true
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true

trading:
  fix:
    # Dev FIX config pointing to DAS Trader dev environment
    config-path: classpath:fix/das-mirror-trading-dev.cfg
